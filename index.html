<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>緊急應變問答遊戲</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 20px;
      background-size: cover;
      background-position: center;
      transition: background-image 0.5s ease-in-out;
    }
    .question {
      display: none;
      animation: bounceIn 0.8s;
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 10px;
    }
    .question.active {
      display: block;
    }
    .options input {
      margin-right: 10px;
    }
    #next-btn, #submit-btn {
      margin-top: 20px;
      padding: 10px 20px;
    }
    #result {
      display: none;
    }
    @keyframes bounceIn {
      0% { transform: scale(0.8); opacity: 0; }
      60% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <h2>緊急應變問答遊戲</h2>
  <div id="quiz"></div>

  <div>
    <button id="next-btn" onclick="nextQuestion()">下一題</button>
    <button id="submit-btn" onclick="submitQuiz()" style="display:none;">送出</button>
  </div>

  <div id="result">
    <h3>答題結果</h3>
    <p id="scoreDisplay"></p>
    <button onclick="exportCSV()">匯出CSV</button>
  </div>

  <script>
    const questionsData = [
      {
        type: "info", html: `
          <label>請輸入員編：</label><br />
          <input type="text" id="empId" required /><br /><br />
          <label>請輸入姓名：</label><br />
          <input type="text" id="empName" required />
        `
      },
      {
        type: "text", question: "1. 你曾經處理過緊急情況嗎？若有，是甚麼情況請簡述"
      },
      {
        type: "multi", correct: ["0", "1"], question: "2. 當顧客失去意識時 CODE 500，第一時間你會做什麼？", options: [
          "A. 由值班經理撥打119 或 授權當區同仁撥打",
          "B. 開啟密錄器",
          "C. 通知家人",
          "D. 等待幫助"
        ]
      },
      {
        type: "single", correct: "2", question: "3. 你聽到第一次 CODE 1000廣播，要先趕往哪裡？", options: [
          "A. 緊急集合地點(文心森林公園)",
          "B. 中控室",
          "C. 火災現場",
          "D. 1F Greeting 入口"
        ]
      },
      {
        type: "single", correct: "1", question: "4. 疏散後到達集合地點，你會做什麼？", options: [
          "A. 等待指示",
          "B. 清點人數",
          "C. 通知媒體",
          "D. 拍照"
        ]
      },
      {
        type: "single", correct: "0", question: "5. 颱風海上警報發布後，你會做什麼？", options: [
          "A. 召集應變小組",
          "B. 通知顧客",
          "C. 拍照",
          "D. 關閉店鋪"
        ]
      },
      {
        type: "multi", correct: ["1", "2", "3"], question: "6. 營業中賣場突然停電時，你會做什麼？", options: [
          "A. 通知媒體",
          "B. 確認發電機正常運作",
          "C. 確認POS正常結帳",
          "D. 安撫顧客",
          "E. 等待幫助",
          "F. 立即啟動CODE 1000疏散顧客"
        ]
      },
      {
        type: "single", correct: "3", question: "7. CODE 1000時，Smaland小朋友何時可被領走？", options: [
          "A. 疏散前",
          "B. 立即",
          "C. 隨時",
          "D. 點名後"
        ]
      },
      {
        type: "single", correct: "2", question: "8. 非轄區警察要求監視器影帶，你會怎麼做？", options: [
          "A. 通知MKT",
          "B. 等待總公司指示",
          "C. 婉轉拒絕",
          "D. 立即提供"
        ]
      },
      {
        type: "multi", correct: ["2", "3", "4"], question: "9. 顧客被賣場展示的破裂碗盤割傷，你會做什麼？", options: [
          "A. 等待幫助",
          "B. 通知媒體",
          "C. 確認現場其他商品",
          "D. 由客服陪同就醫",
          "E. 拍照",
          "F. 啟動保險承諾顧客賠償以示負責"
        ]
      },
      {
        type: "multi", correct: ["1", "2", "4"], question: "10. 員工工作中受傷住院，你會做什麼？", options: [
          "A. 疏散顧客",
          "B. 圍起現場確認有無其他危險",
          "C. 拍下現場照片",
          "D. 通知媒體",
          "E. 立刻通報HR及Safety",
          "F. 填寫CRM"
        ]
      }
    ];

    const quizDiv = document.getElementById("quiz");
    questionsData.forEach((q, i) => {
      const div = document.createElement("div");
      div.className = "question";
      div.id = `q${i}`;
      if (i === 0) div.classList.add("active");

      if (q.type === "info") {
        div.innerHTML = q.html;
      } else if (q.type === "text") {
        div.dataset.type = "text";
        div.innerHTML = `<p>${q.question}</p><textarea rows="4" cols="60"></textarea>`;
      } else {
        div.dataset.type = q.type;
        div.dataset.correct = Array.isArray(q.correct) ? q.correct.join(",") : q.correct;
        div.innerHTML = `<p>${q.question}</p><div class="options">` +
          q.options.map((opt, idx) =>
            `<label><input type="${q.type === 'multi' ? 'checkbox' : 'radio'}" name="q${i}" value="${idx}"> ${opt}</label><br/>`
          ).join("") + "</div>";
      }
      quizDiv.appendChild(div);
    });

    let current = 0;
    let score = 0;
    let quizExport = [];

    const backgrounds = ["", "Q1.webp", "Q2.webp", "Q3.webp", "Q4.webp", "Q5.webp", "Q6.webp", "Q7.webp", "Q8.webp", "Q9.webp", "Q10.webp"];

    function nextQuestion() {
      const questions = document.querySelectorAll(".question");
      const empId = document.getElementById("empId")?.value?.trim();
      const empName = document.getElementById("empName")?.value?.trim();

      if (current === 0 && (!empId || !empName)) {
        alert("請輸入員編與姓名！");
        return;
      }

      if (current < questions.length - 1) {
        questions[current].classList.remove("active");
        current++;
        questions[current].classList.add("active");

        document.body.style.backgroundImage =
          current === 0 ? "none" : `url('${backgrounds[current]}')`;

        document.getElementById("next-btn").style.display =
          current === questions.length - 1 ? "none" : "inline-block";
        document.getElementById("submit-btn").style.display =
          current === questions.length - 1 ? "inline-block" : "none";
      }
    }

    function submitQuiz() {
      score = 0;
      const name = document.getElementById("empName").value.trim();
      const id = document.getElementById("empId").value.trim();
      const totalQuestions = questionsData.length - 1;

      for (let i = 1; i <= totalQuestions; i++) {
        const q = document.getElementById(`q${i}`);
        const type = q.dataset.type;
        const correct = q.dataset.correct;

        if (type === "text") continue;

        if (type === "single") {
          const selected = q.querySelector("input[type='radio']:checked");
          if (selected && selected.value === correct) score++;
        }

        if (type === "multi") {
          const selected = [...q.querySelectorAll("input[type='checkbox']:checked")].map(e => e.value);
          const correctSet = correct.split(",");
          if (
            selected.length === correctSet.length &&
            selected.every(ans => correctSet.includes(ans))
          ) score++;
        }
      }

      document.getElementById("quiz").style.display = "none";
      document.getElementById("next-btn").style.display = "none";
      document.getElementById("submit-btn").style.display = "none";
      document.getElementById("result").style.display = "block";
      document.getElementById("scoreDisplay").innerText = `員編：${id}，姓名：${name}，得分：${score} / ${totalQuestions}`;
      quizExport.push({ id, name, score });
    }

    function exportCSV() {
      const rows = [["員編", "姓名", "得分"]];
      quizExport.forEach(row => {
        rows.push([row.id, row.name, row.score]);
      });
      const csvContent = rows.map(e => e.join(",")).join("\n");
      const blob = new Blob(["\ufeff" + csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "quiz_result.csv";
      a.click();
    }
  </script>
</body>
</html>
